# ระบบประเมินรายงานสอบสวนโรคอาหารเป็นพิษเบื้องต้น (Spot Report Evaluation)

## ภาพรวม

โปรเจกต์นี้คือระบบอัตโนมัติสำหรับประเมินรายงานการสอบสวนโรคอาหารเป็นพิษเบื้องต้น (Spot Report) โดยเปรียบเทียบมาตรการที่ดำเนินการไปแล้วกับ "แนวทางการสอบสวนและควบคุมโรคอาหารเป็นพิษ"

ระบบใช้เทคโนโลยี Large Language Models (LLMs) ร่วมกับ Retrieval-Augmented Generation (RAG) เพื่อวิเคราะห์เนื้อหารายงาน, สรุปประเด็นสำคัญ, และให้ข้อเสนอแนะในการปรับปรุงมาตรการให้สอดคล้องกับแนวทางปฏิบัติที่เป็นมาตรฐาน

## เอกสารที่ใช้

1.  **รายงานสอบสวนโรค (Spot Report)**: `Docs/Exsum_food_poisoning.pdf`
    - เป็นไฟล์ PDF ตัวอย่างของรายงานสอบสวนโรคอาหารเป็นพิษเบื้องต้นที่จะนำมาประเมิน
2.  **คู่มือแนวทางปฏิบัติ (Guideline)**: `Docs/Guideline.pdf` (ชื่อเดิม: `แนวทางการสอบสวนและควบคุมโรคอาหารเป็นพิษ.pdf`)
    - เป็นเอกสารอ้างอิงหลักที่ใช้สร้างคลังความรู้ (Knowledge Base) สำหรับระบบ RAG

## เทคโนโลยีหลัก

- **Python 3.10+**
- **Large Language Models (LLMs)**:
  - `qwen/qwen3-32b`: ใช้สำหรับสรุปเนื้อหาและวิเคราะห์รายงาน
  - `llama-3.1-8b-instant`: ใช้สำหรับวิเคราะห์รายงาน (เป็นอีกทางเลือกหนึ่ง)
- **Groq API**: แพลตฟอร์มสำหรับรัน LLMs ด้วยความเร็วสูง
- **Sentence Transformers (`BAAI/bge-m3`)**: สำหรับสร้าง Vector Embeddings จากเนื้อหาคู่มือฯ
- **Pandas**: สำหรับจัดการและส่งออกผลลัพธ์
- **PyPDF2**: สำหรับดึงข้อมูลจากไฟล์ PDF

## กระบวนการทำงาน

การทำงานของระบบแบ่งออกเป็น 3 ส่วนหลัก ซึ่งทั้งหมดถูกรวมอยู่ในไฟล์ `Full_Pipeline.ipynb`

### ส่วนที่ 1: การสร้างคลังความรู้จากคู่มือ (RAG System)

1.  **ดึงข้อมูล**: ระบบจะอ่านเนื้อหาจากไฟล์ `Docs/Guideline.pdf` โดยเน้นเฉพาะส่วน "ความรู้ทั่วไปของโรค" และ "แนวทางการสอบสวนการระบาด"
2.  **ประมวลผลและแบ่งส่วน (Chunking)**: ข้อความจะถูกทำความสะอาดและแบ่งออกเป็นส่วนย่อยๆ (Chunks) ที่มีขนาดเหมาะสม
3.  **สร้าง Embeddings**: แต่ละ Chunk จะถูกแปลงเป็นเวกเตอร์ตัวเลข (Embeddings) ด้วยโมเดล `BAAI/bge-m3`
4.  **บันทึก**: Chunks และ Embeddings จะถูกบันทึกเป็นไฟล์ `.pkl` (`my_medical_ragv2.pkl`) เพื่อให้สามารถโหลดมาใช้งานได้ทันทีในครั้งถัดไปโดยไม่ต้องประมวลผลใหม่

### ส่วนที่ 2: การวิเคราะห์รายงานสอบสวนโรค (Main Pipeline)

1.  **ดึงข้อมูล**: ระบบอ่านเนื้อหาทั้งหมดจากไฟล์ Spot Report (`Docs/Exsum_food_poisoning.pdf`)
2.  **แยกส่วน**: เนื้อหาจะถูกวิเคราะห์และแบ่งออกเป็นหัวข้อต่างๆ เช่น "ความเป็นมา", "ผลการสอบสวน", "สิ่งที่ดำเนินการไปแล้ว"
3.  **สรุปความ**: LLM (Qwen) จะทำการสรุปเนื้อหาในส่วน "ความเป็นมา" และ "ผลการสอบสวน" ให้เป็นรูปแบบที่มีโครงสร้างและกระชับ
4.  **วิเคราะห์เบื้องต้น**: ข้อมูลสรุปและเนื้อหาส่วนอื่นๆ จะถูกส่งให้ LLM (Qwen หรือ Llama) เพื่อประเมินความเพียงพอของมาตรการที่ได้ดำเนินการไปแล้ว และให้ข้อเสนอแนะเบื้องต้นในรูปแบบ JSON

### ส่วนที่ 3: การปรับปรุงข้อเสนอแนะด้วย RAG (RAG Enhancement)

1.  **ค้นหาข้อมูล**: ข้อเสนอแนะเบื้องต้นที่ได้จากส่วนที่ 2 จะถูกนำไปใช้เป็นคำค้น (Query) ในคลังความรู้ (RAG System) ที่สร้างจากคู่มือฯ
2.  **วิเคราะห์เชิงลึก**: LLM จะได้รับ "ข้อเสนอแนะเดิม" พร้อมกับ "ข้อมูลสนับสนุนจากคู่มือฯ" ที่ค้นเจอ เพื่อทำการวิเคราะห์เปรียบเทียบ
3.  **สร้างข้อเสนอแนะฉบับปรับปรุง**: LLM จะปรับปรุงข้อเสนอแนะเดิมให้มีความสมบูรณ์, ถูกต้อง, และอ้างอิงตามหลักการในคู่มือฯ ได้อย่างชัดเจนยิ่งขึ้น พร้อมระบุแหล่งที่มาและเลขหน้าจากคู่มือ
4.  **รวมผลลัพธ์**: ผลลัพธ์สุดท้ายที่ผ่านการปรับปรุงด้วย RAG จะถูกรวมกลับเข้าไปในไฟล์ JSON เดิม เพื่อให้ได้ผลการประเมินฉบับสมบูรณ์

## วิธีการใช้งาน

1.  **ติดตั้ง Dependencies**:
    ```bash
    pip install -r requirements.txt
    ```
2.  **ตั้งค่า API Key**:
    - เปิดไฟล์ `Full_Pipeline.ipynb`
    - แก้ไขค่า `GROQ_API_KEY` ในเซลล์ที่ 2 และ 5 ให้เป็น API Key ของคุณ
3.  **เตรียมไฟล์**:
    - ตรวจสอบว่ามีไฟล์ `Docs/Exsum_food_poisoning.pdf` และ `Docs/Guideline.pdf` อยู่ในตำแหน่งที่ถูกต้อง
4.  **รัน Pipeline**:
    - รันเซลล์ทั้งหมดใน `Full_Pipeline.ipynb` ตามลำดับ
    - ในการรันครั้งแรก ระบบจะใช้เวลาในการสร้างไฟล์ `my_medical_ragv2.pkl` ซึ่งเป็นคลังความรู้ RAG
    - การรันครั้งถัดไปจะเร็วขึ้น เพราะระบบจะโหลดไฟล์ `.pkl` ที่สร้างไว้แล้ว
5.  **ดูผลลัพธ์**:
    - ผลการวิเคราะห์ทั้งหมดจะถูกบันทึกเป็นไฟล์ `analysis_results_rag_multi.csv` และ `analysis_results_rag_latest.xlsx`
    - สามารถดูผลลัพธ์เบื้องต้นในรูปแบบตาราง (DataFrame) ได้ที่เซลล์ท้ายๆ ของ Notebook
